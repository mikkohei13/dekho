<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dekho</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">
</head>
<body>
  <nav id="top-nav" aria-label="Primary">
    <div class="brand">Dekho</div>
    <a class="scan-link" href="/scan">Scan music folder</a>
  </nav>

  <main id="app-shell">
    <aside id="tracks-panel" aria-labelledby="tracks-heading">
      <header class="panel-header">
        <h1 id="tracks-heading">Music Tracks</h1>
      </header>

      <section id="tracks-list" aria-label="Track list">
        {% if tracks %}
          <ul class="track-items">
            {% for track in tracks %}
              <li class="track-item" data-track-id="{{ track.track_id }}" tabindex="0">
                <h2 class="track-path">{{ track.filepath }}</h2>
                <p class="track-id">{{ track.track_id }}</p>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="empty-state">No tracks in the database under <code>./music</code> yet.</p>
        {% endif %}
      </section>
    </aside>

    <section id="content-panel" aria-label="Details panel">
      <p class="empty-state">Select a track to view details.</p>
    </section>
  </main>
  <script>
    const trackItems = document.querySelectorAll(".track-item");
    const contentPanel = document.getElementById("content-panel");
    let activeTrackId = null;

    function escapeHtml(value) {
      return String(value ?? "").replace(/[&<>"']/g, (char) => (
        {"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[char]
      ));
    }

    function renderDetails(data) {
      const title = data.title ?? "";
      const trackId = data.track_id ?? "";
      const url = data.url ?? "";
      const filepath = data.filepath ?? "";
      const duration = data.duration ?? "";
      const dateCreated = data.date_created ?? "";
      const tags = data.tags ?? "";
      const negativeTags = data.negative_tags ?? "";
      const prompt = data.prompt ?? "";

      contentPanel.innerHTML = `
        <section id="track-info" aria-label="Track information">
          <header class="panel-header"><h2>${escapeHtml(title || "Untitled Track")}</h2></header>
          <div class="remote-actions">
            <button id="get-remote-data-btn" type="button">Get data from Suno</button>
            <span id="remote-data-error" class="remote-data-error" aria-live="polite"></span>
          </div>
          <dl class="track-details">
            <div><dt>track_id</dt><dd>${escapeHtml(trackId)}</dd></div>
            <div><dt>url</dt><dd>${url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>` : "-"}</dd></div>
            <div><dt>filepath</dt><dd>${escapeHtml(filepath)}</dd></div>
            <div><dt>duration</dt><dd>${escapeHtml(duration)}</dd></div>
            <div><dt>date_created</dt><dd>${escapeHtml(dateCreated)}</dd></div>
            <div><dt>tags</dt><dd>${escapeHtml(tags || "-")}</dd></div>
            <div><dt>negative_tags</dt><dd>${escapeHtml(negativeTags || "-")}</dd></div>
            <div><dt>prompt</dt><dd>${escapeHtml(prompt || "-")}</dd></div>
          </dl>
        </section>
      `;
    }

    async function loadTrackDetails(trackId, item) {
      trackItems.forEach((trackItem) => trackItem.classList.remove("is-active"));
      item.classList.add("is-active");
      activeTrackId = trackId;
      contentPanel.innerHTML = '<p class="empty-state">Loading track details...</p>';

      try {
        const response = await fetch(`/api/tracks/${encodeURIComponent(trackId)}`);
        if (!response.ok) {
          throw new Error("Unable to load track details.");
        }
        const data = await response.json();
        renderDetails(data);
      } catch (error) {
        contentPanel.innerHTML = `<p class="empty-state">${escapeHtml(error.message || "Unable to load track details.")}</p>`;
      }
    }

    async function fetchRemoteData(trackId) {
      const button = document.getElementById("get-remote-data-btn");
      const error = document.getElementById("remote-data-error");
      if (!button || !error) {
        return;
      }

      error.textContent = "";
      button.disabled = true;
      button.textContent = "Fetching...";

      try {
        const response = await fetch(`/api/tracks/${encodeURIComponent(trackId)}/remote-data`, {
          method: "POST",
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || "Failed to fetch data from Suno.");
        }
        renderDetails(payload);
      } catch (fetchError) {
        error.textContent = fetchError.message || "Failed to fetch data from Suno.";
      } finally {
        const nextButton = document.getElementById("get-remote-data-btn");
        if (nextButton) {
          nextButton.disabled = false;
          nextButton.textContent = "Get data from Suno";
        }
      }
    }

    trackItems.forEach((item) => {
      const trackId = item.dataset.trackId;
      if (!trackId) {
        return;
      }

      item.addEventListener("click", () => loadTrackDetails(trackId, item));
      item.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          loadTrackDetails(trackId, item);
        }
      });
    });

    contentPanel.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }
      if (target.id === "get-remote-data-btn" && activeTrackId) {
        fetchRemoteData(activeTrackId);
      }
    });
  </script>
</body>
</html>
