<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dekho</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">
</head>
<body>
  <nav id="top-nav" aria-label="Primary">
    <div class="brand">Dekho</div>
    <a class="scan-link" href="/scan">Scan music folder</a>
  </nav>

  <main id="app-shell">
    <aside id="tracks-panel" aria-labelledby="tracks-heading">
      <header class="panel-header">
        <h1 id="tracks-heading">Music Tracks</h1>
      </header>

      <section id="tracks-list" aria-label="Track list">
        {% if tracks %}
          <ul class="track-items">
            {% for track in tracks %}
              <li class="track-item" data-track-id="{{ track.track_id }}" tabindex="0">
                <h2 class="track-title">
                  {{ track.display_title }}
                  {% if track.has_remote_tags %}
                    <span class="remote-tags-indicator" aria-label="Remote metadata available" title="Remote metadata fetched from Suno">✦</span>
                  {% endif %}
                </h2>
                <p class="track-id">{{ track.track_id }}</p>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="empty-state">No tracks in the database under <code>./music</code> yet.</p>
        {% endif %}
      </section>
    </aside>

    <section id="content-panel" aria-label="Details panel">
      <p class="empty-state">Select a track to view details.</p>
    </section>
  </main>
  <script>
    const trackItems = document.querySelectorAll(".track-item");
    const contentPanel = document.getElementById("content-panel");
    let activeTrackId = null;

    function escapeHtml(value) {
      return String(value ?? "").replace(/[&<>"']/g, (char) => (
        {"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[char]
      ));
    }

    function getDisplayTitle(data) {
      return data.title_new || data.title || "Unknown";
    }

    function hasRemoteTags(tags) {
      return tags !== null && tags !== undefined && String(tags).trim() !== "";
    }

    function remoteTagsIndicatorHtml() {
      return '<span class="remote-tags-indicator" aria-label="Remote metadata available" title="Remote metadata fetched from Suno">✦</span>';
    }

    function updateTrackListTitle(trackId, data) {
      const trackItem = document.querySelector(`.track-item[data-track-id="${CSS.escape(trackId)}"]`);
      if (!trackItem) {
        return;
      }
      const titleElement = trackItem.querySelector(".track-title");
      if (!titleElement) {
        return;
      }
      const displayTitle = getDisplayTitle(data);
      titleElement.innerHTML = `${escapeHtml(displayTitle)}${hasRemoteTags(data.tags) ? remoteTagsIndicatorHtml() : ""}`;
    }

    function renderDetails(data) {
      const title = data.title ?? "";
      const titleNew = data.title_new ?? "";
      const notes = data.notes ?? "";
      const displayTitle = titleNew || title || "Untitled Track";
      const trackId = data.track_id ?? "";
      const audioSrc = trackId
        ? `/api/tracks/${encodeURIComponent(trackId)}/audio`
        : "";
      const url = data.url ?? "";
      const filepath = data.filepath ?? "";
      const duration = data.duration ?? "";
      const dateCreated = data.date_created ?? "";
      const tags = data.tags ?? "";
      const negativeTags = data.negative_tags ?? "";
      const prompt = data.prompt ?? "";

      contentPanel.innerHTML = `
        <section id="track-info" aria-label="Track information">
          <header class="panel-header">
            <h2>${escapeHtml(displayTitle)}${hasRemoteTags(tags) ? remoteTagsIndicatorHtml() : ""}</h2>
            <audio id="selected-track-player" controls preload="metadata" src="${escapeHtml(audioSrc)}">
              Your browser does not support audio playback.
            </audio>
          </header>
          <div class="track-form">
            <form id="track-user-data-form">
              <label for="title-new-input">title_new</label>
              <input id="title-new-input" name="title_new" type="text" value="${escapeHtml(titleNew)}">
              <label for="notes-input">notes</label>
              <textarea id="notes-input" name="notes" rows="4">${escapeHtml(notes)}</textarea>
              <div class="track-user-data-actions">
                <button id="save-track-user-data-btn" type="button">Save</button>
                <span id="track-user-data-error" class="track-user-data-error" aria-live="polite"></span>
              </div>
            </form>
          </div>
          <div class="track-details">
            <p id="track-info-title">${escapeHtml(title || "-")}</p>
            <p id="track-info-id">${escapeHtml(trackId)}</p>
            <p id="track-info-url">${url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>` : "-"}<p>
            <p id="track-info-filepath">${escapeHtml(filepath)}</p>
            <p id="track-info-duration">${escapeHtml(duration)}</p>
            <p id="track-info-date-created">${escapeHtml(dateCreated)}</p>
          </div>
          <div class="track-moredetails">
            <div class="remote-actions">
              <button id="get-remote-data-btn" type="button">Get data from Suno</button>
              <span id="remote-data-error" class="remote-data-error" aria-live="polite"></span>
            </div>
            <h4>Tags</h4>
            <div id="track-info-tags">${escapeHtml(tags || "-")}</div>
            <h4>Negative Tags</h4>
            <div id="track-info-negative-tags">${escapeHtml(negativeTags || "-")}</div>
            <h4>Lyrics Prompt</h4>
            <div id="track-info-prompt">${escapeHtml(prompt || "-")}</div>
          </div>
        </section>
      `;
    }

    async function loadTrackDetails(trackId, item) {
      trackItems.forEach((trackItem) => trackItem.classList.remove("is-active"));
      item.classList.add("is-active");
      activeTrackId = trackId;
      contentPanel.innerHTML = '<p class="empty-state">Loading track details...</p>';

      try {
        const response = await fetch(`/api/tracks/${encodeURIComponent(trackId)}`);
        if (!response.ok) {
          throw new Error("Unable to load track details.");
        }
        const data = await response.json();
        updateTrackListTitle(trackId, data);
        renderDetails(data);
      } catch (error) {
        contentPanel.innerHTML = `<p class="empty-state">${escapeHtml(error.message || "Unable to load track details.")}</p>`;
      }
    }

    async function fetchRemoteData(trackId) {
      const button = document.getElementById("get-remote-data-btn");
      const error = document.getElementById("remote-data-error");
      if (!button || !error) {
        return;
      }

      error.textContent = "";
      button.disabled = true;
      button.textContent = "Fetching...";

      try {
        const response = await fetch(`/api/tracks/${encodeURIComponent(trackId)}/remote-data`, {
          method: "POST",
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || "Failed to fetch data from Suno.");
        }
        updateTrackListTitle(trackId, payload);
        renderDetails(payload);
      } catch (fetchError) {
        error.textContent = fetchError.message || "Failed to fetch data from Suno.";
      } finally {
        const nextButton = document.getElementById("get-remote-data-btn");
        if (nextButton) {
          nextButton.disabled = false;
          nextButton.textContent = "Get data from Suno";
        }
      }
    }

    async function saveUserData(trackId) {
      const button = document.getElementById("save-track-user-data-btn");
      const error = document.getElementById("track-user-data-error");
      const titleInput = document.getElementById("title-new-input");
      const notesInput = document.getElementById("notes-input");
      if (
        !button ||
        !error ||
        !(titleInput instanceof HTMLInputElement) ||
        !(notesInput instanceof HTMLTextAreaElement)
      ) {
        return;
      }

      error.textContent = "";
      button.disabled = true;
      button.textContent = "Saving...";

      try {
        const response = await fetch(`/api/tracks/${encodeURIComponent(trackId)}/user-data`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title_new: titleInput.value,
            notes: notesInput.value,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || "Failed to save track data.");
        }
        updateTrackListTitle(trackId, payload);
        renderDetails(payload);
      } catch (saveError) {
        error.textContent = saveError.message || "Failed to save track data.";
      } finally {
        const nextButton = document.getElementById("save-track-user-data-btn");
        if (nextButton) {
          nextButton.disabled = false;
          nextButton.textContent = "Save";
        }
      }
    }

    trackItems.forEach((item) => {
      const trackId = item.dataset.trackId;
      if (!trackId) {
        return;
      }

      item.addEventListener("click", () => loadTrackDetails(trackId, item));
      item.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          loadTrackDetails(trackId, item);
        }
      });
    });

    contentPanel.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }
      if (target.id === "get-remote-data-btn" && activeTrackId) {
        fetchRemoteData(activeTrackId);
      }
      if (target.id === "save-track-user-data-btn" && activeTrackId) {
        saveUserData(activeTrackId);
      }
    });
  </script>
</body>
</html>
